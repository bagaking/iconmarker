# Icon Marker 增强计划 PRD

## 1. 项目概述与目标

Icon Marker 是一个用于在图像上添加文本的 Go 语言库，我们的增强目标是将其打造成一个专注于群组图标生成的高效工具。

### 1.1 核心目标
1. **减少依赖**: 支持 SVG 渲染，减少大型图片资源依赖
2. **提高性能**: 降低图标生成时间，支持高并发批量处理
3. **增强效果**: 添加基础图像处理能力，满足群组图标多样化需求

### 1.2 价值评估
- **存储成本降低**: SVG 支持减少图片存储空间要求（高达90%）
- **开发成本降低**: 无需依赖设计师资源即可生成专业图标
- **用户体验提升**: 更丰富的图标效果增强群组识别度

## 2. 优先级功能（核心交付项）

对功能进行优先级排序，确保资源集中在最有价值的改进上。优先级分为：P0（必须）、P1（重要）、P2（待定）。

### 2.1 P0: 基础建设（核心基础设施）

**目标**: 建立统一的底层基础设施，为所有其他功能提供支持。

**技术要求**:
1. **统一资源缓存基础设施**
   - 支持多种资源类型（SVG、字体、图像）的统一缓存机制
   - 提供通用资源接口，支持资源大小估算、资源克隆
   - 实现 LRU 或类似策略的缓存淘汰机制
   - 支持并发安全操作

2. **模块化架构设计**
   - 定义清晰的组件接口，保证组件间低耦合
   - 渲染器接口：支持 SVG 和文本渲染
   - 滤镜接口：支持各类图像效果处理
   - 高层服务接口：整合底层组件提供完整功能

3. **并行处理框架**
   - 支持多任务并行执行的工作池
   - 支持任务提交、执行、等待和错误处理
   - 能够根据系统资源动态调整并行度

4. **性能监控与测试框架**
   - 建立基准测试集
   - 实现性能指标收集与监控
   - 确保每次功能迭代都不破坏性能指标

### 2.2 P0: SVG 支持

**目标**: 提供高性能的 SVG 渲染能力，作为群组图标生成的基础。

**技术要求**:
1. **高效 SVG 渲染引擎**
   - 支持常见矢量图形元素
   - 使用高效的渲染算法（如扫描线算法）
   - 支持多种 SVG 特性（基本形状、路径、文本等）
   - 渲染性能达到 30ms 以内（512x512 尺寸）

2. **SVG 缓存机制**
   - 避免重复解析相同的 SVG 内容
   - 缓存 SVG 解析结果，提高渲染效率
   - 支持缓存项过期和清理
   - 并发安全的缓存访问

3. **基础模板系统**
   - 提供 10 个常用群组类型的基础 SVG 图形
   - 项目组、讨论组、兴趣小组等预设模板
   - 每个模板支持参数化（颜色、尺寸、装饰元素）

4. **SVG 与文本集成**
   - 确保现有文本渲染能力可以与 SVG 无缝配合
   - 文本定位算法优化，确保在 SVG 背景上正确渲染文本
   - 支持透明背景 SVG 与文本组合

### 2.3 P1: 核心滤镜效果

**目标**: 提供最基础且常用的图像处理能力，满足群组图标基本视觉效果需求。

**技术要求**:
1. **灰度转换**
   - 将彩色图像转为灰度
   - 根据颜色通道加权计算灰度值
   - 保持原图像的透明度信息

2. **颜色着色**
   - 为图像添加统一色调
   - 用途：根据群组类型设置不同基色
   - 技术要求：保留亮度信息，替换色相和饱和度

3. **透明度调整**
   - 控制图像或元素的透明度
   - 用途：实现半透明背景，突出前景内容
   - 支持全局或区域性透明度调整

## 3. 迭代计划

采用基础先行的迭代开发策略，确保核心基础设施先行建立，再逐步构建功能。

### 迭代1: 基础设施建设
- **目标**: 建立项目的核心架构和基础设施
- **可交付**:
  - 统一资源缓存系统设计与实现
  - 模块化组件架构与接口定义
  - 并行处理框架
  - 性能测试基础设施
- **验收标准**:
  - 完整的接口与组件文档
  - 资源管理器缓存命中率 > 90%（测试环境）
  - 单元测试覆盖率 > 80%

### 迭代2: SVG基础能力
- **目标**: 在基础设施上实现SVG解析与渲染
- **可交付**:
  - 基础SVG解析与渲染引擎
  - SVG资源管理集成
  - 2个基础SVG模板原型
- **验收标准**:
  - SVG渲染时间 < 30ms（512x512尺寸）
  - 成功解析并渲染W3C SVG 1.1核心元素

### 迭代3: 并行渲染与文本集成
- **目标**: 优化性能并集成文本功能
- **可交付**:
  - SVG与并行处理框架集成
  - 文本渲染与SVG集成
  - 优化的字体大小算法
- **验收标准**:
  - 并行渲染比串行快40%以上
  - 文本在SVG上正确渲染

### 迭代4: 滤镜效果与模板完善
- **目标**: 实现滤镜效果并完善模板系统
- **可交付**:
  - 基础滤镜（灰度、着色、透明度）
  - 10个完整SVG模板
  - 全面性能优化
  - 完整API文档
- **验收标准**:
  - 批量生成性能提升50%
  - 所有功能的集成测试通过

## 4. 执行指南

### 4.1 开发准备

**环境要求**:
- Go 1.16或更高版本
- 相关依赖：SVG处理库、字体渲染库
- 性能测试环境

**性能测试环境**:
- 准备专用的性能测试套件
- 设置基线性能指标
- 建立自动化性能回归测试流程

**测试数据准备**:
- 5个代表性SVG测试文件（从简单到复杂）
- 5个常用字体文件
- 10个不同尺寸的背景图像用于对比测试

### 4.2 技术决策与优化方向

**架构设计原则**:
- 采用面向对象设计，明确接口与实现分离
- **先实现基础设施，再构建具体功能**
- 统一缓存基础设施，支持多种资源类型
- 渲染器与资源管理分离，提高模块化程度

**SVG渲染优化重点**:
- 使用扫描线算法加速渲染
- 实现智能缓存减少重复解析
- 考虑使用 SIMD 指令集优化像素处理（可选）

**并行化策略**:
- SVG渲染和文本渲染并行
- 大型SVG分块并行渲染
- 批量处理时的请求级并行

**内存优化**:
- 减少临时对象创建
- 使用对象池减少GC压力
- 图像处理时考虑原地操作

### 4.3 风险控制

**主要风险与缓解策略**:

1. **SVG渲染性能问题**
   - 风险: 复杂SVG可能导致渲染缓慢
   - 缓解: 设置复杂度上限，大型SVG进行预处理优化

2. **SVG特性兼容性**
   - 风险: 某些SVG高级特性可能不支持
   - 缓解: 明确支持范围，提供替代方案指南

3. **并发安全问题**
   - 风险: 并行渲染可能导致资源竞争
   - 缓解: 全面的并发测试，资源锁策略优化

## 5. 关键接口设计

### 5.1 统一缓存基础设施

**CacheItem 接口**
- 用于估算缓存项的大小
- 方法: Size() int

**Resource 接口**
- 继承 CacheItem 接口
- 提供资源克隆能力
- 方法: Clone() Resource

**Cache 接口**
- 提供基本缓存操作
- 方法: Get, Put, Remove, Clear, Size

**ResourceManager**
- 管理不同类型的资源缓存
- 支持 SVG、字体、图像等资源类型
- 提供资源获取、缓存和释放方法

### 5.2 渲染器接口

**Renderer 接口**
- 基础渲染接口
- 方法: Render(options interface{}) (image.Image, error)

**SVGRenderer**
- 实现 Renderer 接口
- 负责 SVG 解析和渲染
- 支持单个和批量 SVG 渲染

**TextRenderer**
- 实现 Renderer 接口
- 负责文本渲染
- 支持字体选择、大小调整、效果应用

### 5.3 图标服务接口

**IconService**
- 高层服务接口，整合其他组件
- 方法: CreateGroupIcon(name, groupType string, size int) (image.Image, error)
- 方法: BatchCreateIcons(requests []IconRequest) ([]image.Image, error)

## 6. 评估指标

聚焦于性能和质量的关键指标。

### 6.1 性能指标
- SVG渲染时间: < 30ms (512x512尺寸)
- 整体图标生成时间: < 50ms (包含文本和效果)
- 批量处理吞吐量: > 50个/秒 (10个线程)
- 内存占用: 峰值 < 50MB (1000个图标批处理)

### 6.2 质量指标
- SVG渲染准确性: 与浏览器渲染结果相似度 > 95%
- 文本显示质量: 清晰可辨，无锯齿
- 单元测试覆盖率: > 80%
- 性能回归测试: 确保性能不下降

### 6.3 存储指标
- 与JPEG/PNG相比，存储空间减少: > 80%
- 网络传输带宽降低: > 70%

## 7. 后续计划（P2优先级）

这些功能被评估为重要但非必须，可视资源情况在后续迭代中实现：

1. **高级文本效果** - 渐变、发光等特效
2. **SVG动画支持** - 简单的帧动画能力
3. **完整图层系统** - 支持多层合成和混合模式
4. **批处理API** - 专用批量图标生成接口 